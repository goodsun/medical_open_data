<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MODS â€” Medical Open Data Search</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif; background: #f8f9fa; color: #333; }

header {
  background: linear-gradient(135deg, #1a73e8, #0d47a1);
  color: white; padding: 1.5rem 2rem;
}
header h1 { font-size: 1.5rem; font-weight: 700; }
header h1 span { font-weight: 300; opacity: 0.85; font-size: 0.85rem; margin-left: 0.5rem; }
header p { font-size: 0.85rem; opacity: 0.8; margin-top: 0.3rem; }

.container { max-width: 1200px; margin: 0 auto; padding: 1rem; }

/* ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚¿ãƒ– */
.data-tabs {
  display: flex; gap: 0; margin-bottom: 1rem;
}
.data-tab {
  padding: 0.7rem 1.5rem; border: 2px solid #ddd; background: #f1f3f4;
  cursor: pointer; font-size: 0.9rem; font-weight: 600; color: #666;
  transition: all 0.2s; border-bottom: none;
}
.data-tab:first-child { border-radius: 10px 0 0 0; }
.data-tab:last-child { border-radius: 0 10px 0 0; }
.data-tab.active-medical { background: #1a73e8; color: white; border-color: #1a73e8; }
.data-tab.active-kaigo { background: #2e7d32; color: white; border-color: #2e7d32; }

.search-panel {
  background: white; border-radius: 0 12px 12px 12px; padding: 1.2rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1rem;
}
.search-row { display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: end; }
.field { display: flex; flex-direction: column; gap: 0.3rem; }
.field label { font-size: 0.75rem; font-weight: 600; color: #666; }
.field input, .field select {
  padding: 0.5rem 0.7rem; border: 1.5px solid #ddd; border-radius: 8px;
  font-size: 0.9rem; outline: none; transition: border 0.2s;
}
.field input:focus, .field select:focus { border-color: #1a73e8; }
button.search-btn {
  padding: 0.5rem 1.5rem; color: white;
  border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600;
  cursor: pointer; transition: background 0.2s; white-space: nowrap;
}
button.search-btn.medical { background: #1a73e8; }
button.search-btn.medical:hover { background: #1557b0; }
button.search-btn.kaigo { background: #2e7d32; }
button.search-btn.kaigo:hover { background: #1b5e20; }
button.search-btn:disabled { background: #aaa; cursor: wait; }
.locate-btn {
  padding: 0.5rem 0.8rem; background: #f1f3f4; border: 1.5px solid #ddd;
  border-radius: 8px; cursor: pointer; font-size: 1rem; transition: background 0.2s;
}
.locate-btn:hover { background: #e2e5e8; }

.content { display: flex; gap: 1rem; }
#map {
  flex: 1; height: 500px; min-height: 500px; border-radius: 0 0 0 12px;
  border: 1px solid #e0e0e0; min-width: 300px; z-index: 1;
}
.results-panel {
  width: 380px; max-height: 500px; overflow-y: auto;
  background: white; border-radius: 0 0 12px 0;
  border: 1px solid #e0e0e0; border-left: none;
}
.result-item {
  padding: 0.8rem 1rem; border-bottom: 1px solid #f0f0f0;
  cursor: pointer; transition: background 0.15s;
}
.result-item:hover { background: #f8f9ff; }
.result-item.active { background: #e8f0fe; }
.result-name { font-weight: 600; font-size: 0.9rem; }
.result-addr { font-size: 0.78rem; color: #666; margin-top: 0.2rem; }
.result-meta { font-size: 0.75rem; color: #888; margin-top: 0.3rem; display: flex; gap: 0.8rem; flex-wrap: wrap; }
.result-meta .dist { color: #1a73e8; font-weight: 600; }
.result-meta .type { padding: 0.1rem 0.5rem; border-radius: 4px; font-size: 0.72rem; }
.result-meta .type-medical { background: #e8f0fe; color: #1a73e8; }
.result-meta .type-kaigo { background: #e8f5e9; color: #2e7d32; }
.no-results { padding: 2rem; text-align: center; color: #999; }
.loading { padding: 2rem; text-align: center; color: #666; }

.stats-bar {
  font-size: 0.78rem; color: #888; padding: 0.5rem 1rem;
  background: #fafafa; border-bottom: 1px solid #f0f0f0;
}

/* ä»‹è­·ãƒ•ã‚£ãƒ«ã‚¿ */
.kaigo-filters { display: none; margin-top: 0.6rem; }
.kaigo-filters.show { display: flex; flex-wrap: wrap; gap: 0.4rem; }
.category-chip {
  padding: 0.3rem 0.7rem; border-radius: 16px; font-size: 0.78rem;
  border: 1.5px solid #ddd; background: white; cursor: pointer;
  transition: all 0.2s; color: #666;
}
.category-chip:hover { border-color: #2e7d32; color: #2e7d32; }
.category-chip.active { background: #2e7d32; color: white; border-color: #2e7d32; }

footer {
  text-align: center; padding: 1.5rem; font-size: 0.78rem; color: #999;
}
footer a { color: #1a73e8; text-decoration: none; }

.detail-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4); z-index: 1000; justify-content: center; align-items: center;
}
.detail-overlay.show { display: flex; }
.detail-card {
  background: white; border-radius: 12px; padding: 1.5rem; width: 90%; max-width: 600px;
  max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
}
.detail-card h2 { font-size: 1.1rem; margin-bottom: 0.3rem; }
.detail-card .close-btn {
  float: right; background: none; border: none; font-size: 1.5rem;
  cursor: pointer; color: #999; line-height: 1;
}
.detail-section { margin-top: 1rem; }
.detail-section h3 { font-size: 0.85rem; color: #1a73e8; margin-bottom: 0.4rem; border-bottom: 1px solid #eee; padding-bottom: 0.3rem; }

.schedule-table {
  width: 100%; border-collapse: collapse; font-size: 0.78rem;
}
.schedule-table th {
  background: #f8f9fa; padding: 0.4rem 0.3rem; font-weight: 600;
  border-bottom: 2px solid #e0e0e0; color: #555; white-space: nowrap;
}
.schedule-table th.day-sat { color: #1a73e8; }
.schedule-table th.day-sun { color: #d32f2f; }
.schedule-table td {
  padding: 0.35rem 0.25rem; border-bottom: 1px solid #f0f0f0;
  text-align: center; white-space: nowrap;
}
.schedule-table td.spec-name {
  text-align: left; font-weight: 500; padding-left: 0.4rem;
  max-width: 120px; overflow: hidden; text-overflow: ellipsis;
}
.schedule-table td.off { color: #ccc; }
.schedule-table td.on { color: #333; font-size: 0.72rem; }

@media (max-width: 768px) {
  .content { flex-direction: column; }
  #map { height: 300px; border-radius: 0; }
  .results-panel { width: 100%; max-height: 400px; border-radius: 0 0 12px 12px; border-left: 1px solid #e0e0e0; }
  .search-row { flex-direction: column; }
  .field { width: 100%; }
}
</style>
</head>
<body>

<header>
  <h1>ğŸ¥ MODS <span>Medical &amp; Care Open Data Search</span></h1>
  <p>åšç”ŸåŠ´åƒçœã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ â€” åŒ»ç™‚æ–½è¨­20ä¸‡ä»¶ + ä»‹è­·äº‹æ¥­æ‰€22ä¸‡ä»¶</p>
</header>

<div class="container">
  <!-- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ– -->
  <div class="data-tabs">
    <div class="data-tab active-medical" id="tabMedical" onclick="switchMode('medical')">ğŸ¥ åŒ»ç™‚æ–½è¨­</div>
    <div class="data-tab" id="tabKaigo" onclick="switchMode('kaigo')">ğŸ¤ ä»‹è­·äº‹æ¥­æ‰€</div>
  </div>

  <div class="search-panel">
    <div class="search-row">
      <div class="field" style="flex:2">
        <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆæ–½è¨­åãƒ»ä½æ‰€ï¼‰</label>
        <input type="text" id="q" placeholder="ä¾‹: æ¸‹è°·ã€ã€‡ã€‡ã‚¯ãƒªãƒ‹ãƒƒã‚¯">
      </div>
      <!-- åŒ»ç™‚ç”¨ãƒ•ã‚£ãƒ«ã‚¿ -->
      <div class="field medical-only" style="flex:1">
        <label>è¨ºç™‚ç§‘</label>
        <input type="text" id="specialty" placeholder="ä¾‹: å†…ç§‘ã€å°å…ç§‘">
      </div>
      <div class="field medical-only" style="flex:1">
        <label>æ–½è¨­ç¨®åˆ¥</label>
        <select id="type">
          <option value="">ã™ã¹ã¦</option>
          <option value="1">ç—…é™¢</option>
          <option value="2">è¨ºç™‚æ‰€</option>
          <option value="3">æ­¯ç§‘</option>
          <option value="4">åŠ©ç”£æ‰€</option>
          <option value="5">è–¬å±€</option>
        </select>
      </div>
      <div class="field medical-only" style="justify-content:end;">
        <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;font-size:0.85rem;font-weight:500;color:#333;">
          <input type="checkbox" id="openNow" style="width:16px;height:16px;cursor:pointer;">
          ğŸ• è¨ºç™‚ä¸­
        </label>
      </div>
      <!-- ä»‹è­·ç”¨ãƒ•ã‚£ãƒ«ã‚¿ -->
      <div class="field kaigo-only" style="flex:1; display:none;">
        <label>ã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥</label>
        <select id="kaigoService">
          <option value="">ã™ã¹ã¦</option>
        </select>
      </div>
      <button class="locate-btn" onclick="geolocate()" title="ç¾åœ¨åœ°ã‚’å–å¾—">ğŸ“</button>
      <button class="search-btn medical" id="searchBtn" onclick="doSearch()">æ¤œç´¢</button>
    </div>
    <!-- ä»‹è­·ã‚«ãƒ†ã‚´ãƒªãƒãƒƒãƒ— -->
    <div class="kaigo-filters" id="kaigoFilters">
      <div class="category-chip" data-cat="" onclick="selectCategory(this)">ã™ã¹ã¦</div>
      <div class="category-chip" data-cat="è¨ªå•ç³»" onclick="selectCategory(this)">ğŸ  è¨ªå•ç³»</div>
      <div class="category-chip" data-cat="é€šæ‰€ç³»" onclick="selectCategory(this)">ğŸ¢ é€šæ‰€ç³»</div>
      <div class="category-chip" data-cat="å…¥æ‰€ç³»" onclick="selectCategory(this)">ğŸ¨ å…¥æ‰€ç³»</div>
      <div class="category-chip" data-cat="çŸ­æœŸå…¥æ‰€ç³»" onclick="selectCategory(this)">ğŸ“… çŸ­æœŸå…¥æ‰€ç³»</div>
      <div class="category-chip" data-cat="å±…ä½ç³»" onclick="selectCategory(this)">ğŸ  å±…ä½ç³»</div>
      <div class="category-chip" data-cat="å±…å®…æ”¯æ´" onclick="selectCategory(this)">ğŸ“‹ å±…å®…æ”¯æ´</div>
      <div class="category-chip" data-cat="ç¦ç¥‰ç”¨å…·" onclick="selectCategory(this)">ğŸ¦½ ç¦ç¥‰ç”¨å…·</div>
      <div class="category-chip" data-cat="åœ°åŸŸå¯†ç€å‹" onclick="selectCategory(this)">ğŸ“ åœ°åŸŸå¯†ç€å‹</div>
      <div class="category-chip" data-cat="è¤‡åˆãƒ»å°è¦æ¨¡" onclick="selectCategory(this)">ğŸ”„ è¤‡åˆãƒ»å°è¦æ¨¡</div>
    </div>
    <div id="geoStatus" style="font-size:0.75rem; color:#888; margin-top:0.4rem;"></div>
  </div>

  <div class="content">
    <div id="map"></div>
    <div class="results-panel">
      <div id="statsBar" class="stats-bar" style="display:none;"></div>
      <div id="results"><div class="no-results">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„ğŸ“ç¾åœ¨åœ°ã‹ã‚‰æ¤œç´¢ã—ã¦ãã ã•ã„</div></div>
    </div>
  </div>
</div>

<div class="detail-overlay" id="detailOverlay" onclick="if(event.target===this)closeDetail()">
  <div class="detail-card" id="detailCard"></div>
</div>

<footer>
  ãƒ‡ãƒ¼ã‚¿å‡ºå…¸: <a href="https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/kenkou_iryou/iryou/newpage_43373.html" target="_blank">åšåŠ´çœ åŒ»ç™‚æƒ…å ±ãƒãƒƒãƒˆ</a>
  ï½œ <a href="https://www.mhlw.go.jp/stf/kaigo-kouhyou_opendata.html" target="_blank">ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±å…¬è¡¨</a>
  ï½œ <a href="/docs" target="_blank">API Playground</a>
  ï½œ <a href="/redoc" target="_blank">API Reference</a>
  ï½œ <a href="https://github.com/goodsun/medical_open_data" target="_blank">GitHub</a>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = '/api/v1';
const TYPE_NAMES = {1:'ç—…é™¢',2:'è¨ºç™‚æ‰€',3:'æ­¯ç§‘',4:'åŠ©ç”£æ‰€',5:'è–¬å±€'};
const TYPE_COLORS = {1:'#d32f2f',2:'#1a73e8',3:'#7b1fa2',4:'#e65100',5:'#2e7d32'};

let map, markers = [], userMarker = null, userLat = null, userLng = null;
let currentMode = 'medical'; // 'medical' or 'kaigo'
let kaigoServices = []; // ã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥ãƒã‚¹ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
let selectedCategory = '';

map = L.map('map').setView([35.681, 139.767], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors', maxZoom: 19
}).addTo(map);
setTimeout(() => map.invalidateSize(), 200);

// ä»‹è­·ã‚µãƒ¼ãƒ“ã‚¹ç¨®åˆ¥ã‚’èª­ã¿è¾¼ã¿
fetch(`${API}/kaigo/services`).then(r => r.json()).then(data => {
  kaigoServices = data;
  const sel = document.getElementById('kaigoService');
  data.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.code;
    opt.textContent = `${s.name}`;
    opt.dataset.category = s.category || '';
    sel.appendChild(opt);
  });
}).catch(() => {});

function switchMode(mode) {
  currentMode = mode;
  const tabM = document.getElementById('tabMedical');
  const tabK = document.getElementById('tabKaigo');
  const btn = document.getElementById('searchBtn');

  tabM.className = 'data-tab' + (mode === 'medical' ? ' active-medical' : '');
  tabK.className = 'data-tab' + (mode === 'kaigo' ? ' active-kaigo' : '');

  document.querySelectorAll('.medical-only').forEach(el => el.style.display = mode === 'medical' ? '' : 'none');
  document.querySelectorAll('.kaigo-only').forEach(el => el.style.display = mode === 'kaigo' ? '' : 'none');
  document.getElementById('kaigoFilters').classList.toggle('show', mode === 'kaigo');

  btn.className = 'search-btn ' + mode;
  document.getElementById('q').placeholder = mode === 'medical'
    ? 'ä¾‹: æ¸‹è°·ã€ã€‡ã€‡ã‚¯ãƒªãƒ‹ãƒƒã‚¯'
    : 'ä¾‹: æ¸‹è°·ã€è¨ªå•ä»‹è­·';
}

function selectCategory(el) {
  document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  selectedCategory = el.dataset.cat;

  // ãƒ•ã‚£ãƒ«ã‚¿selectæ›´æ–°
  const sel = document.getElementById('kaigoService');
  sel.innerHTML = '<option value="">ã™ã¹ã¦</option>';
  kaigoServices.forEach(s => {
    if (!selectedCategory || s.category === selectedCategory) {
      const opt = document.createElement('option');
      opt.value = s.code;
      opt.textContent = s.name;
      sel.appendChild(opt);
    }
  });
}

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function addMarker(fac, idx, isKaigo) {
  if (!fac.latitude || !fac.longitude) return;
  const color = isKaigo ? '#2e7d32' : (TYPE_COLORS[fac.facility_type] || '#666');
  const icon = L.divIcon({
    html: `<div style="background:${color};color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);">${idx+1}</div>`,
    iconSize: [24, 24], iconAnchor: [12, 12], className: ''
  });
  const m = L.marker([fac.latitude, fac.longitude], {icon}).addTo(map);
  const popupText = isKaigo
    ? `<b>${fac.name}</b><br>${fac.service_type||''}<br>${fac.address||''}`
    : `<b>${fac.name}</b><br>${fac.address||''}`;
  m.bindPopup(popupText);
  m.on('click', () => isKaigo ? showKaigoDetail(fac.id) : showDetail(fac.id));
  markers.push(m);
}

function geolocate() {
  const st = document.getElementById('geoStatus');
  if (!navigator.geolocation) { st.textContent = 'ä½ç½®æƒ…å ±éå¯¾å¿œ'; return; }
  st.textContent = 'ğŸ“ å–å¾—ä¸­...';
  navigator.geolocation.getCurrentPosition(pos => {
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;
    st.textContent = `ğŸ“ ${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
    map.setView([userLat, userLng], 15);
    if (userMarker) map.removeLayer(userMarker);
    userMarker = L.marker([userLat, userLng], {
      icon: L.divIcon({
        html: '<div style="background:#4285f4;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 0 8px rgba(66,133,244,0.6);"></div>',
        iconSize: [16,16], iconAnchor: [8,8], className: ''
      })
    }).addTo(map);
  }, () => { st.textContent = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'; });
}

async function doSearch() {
  if (currentMode === 'kaigo') return doSearchKaigo();
  return doSearchMedical();
}

async function doSearchMedical() {
  const q = document.getElementById('q').value.trim();
  const specialty = document.getElementById('specialty').value.trim();
  const type = document.getElementById('type').value;
  const openNow = document.getElementById('openNow').checked;
  const btn = document.getElementById('searchBtn');
  const resultsEl = document.getElementById('results');
  const statsEl = document.getElementById('statsBar');

  btn.disabled = true; btn.textContent = 'æ¤œç´¢ä¸­...';
  resultsEl.innerHTML = '<div class="loading">ğŸ” æ¤œç´¢ä¸­...</div>';
  clearMarkers();

  try {
    let facilities = [], total = 0, isNearby = false;

    if (userLat && !q) {
      const params = new URLSearchParams({lat: userLat, lng: userLng, radius: 3, limit: 30});
      if (specialty) params.set('specialty', specialty);
      if (type) params.append('type', type);
      if (openNow) params.set('open_now', 'true');
      const res = await fetch(`${API}/facilities/nearby?${params}`);
      facilities = await res.json();
      total = facilities.length;
      isNearby = true;
    } else {
      const params = new URLSearchParams({per_page: 30});
      if (q) params.set('q', q);
      if (specialty) params.set('specialty', specialty);
      if (type) params.append('type', type);
      if (openNow) params.set('open_now', 'true');
      const res = await fetch(`${API}/facilities?${params}`);
      const data = await res.json();
      facilities = data.data;
      total = data.pagination.total;
    }

    renderResults(facilities, total, isNearby, false);
  } catch (e) {
    resultsEl.innerHTML = `<div class="no-results">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
  } finally {
    btn.disabled = false; btn.textContent = 'æ¤œç´¢';
  }
}

async function doSearchKaigo() {
  const q = document.getElementById('q').value.trim();
  const service = document.getElementById('kaigoService').value;
  const btn = document.getElementById('searchBtn');
  const resultsEl = document.getElementById('results');
  const statsEl = document.getElementById('statsBar');

  btn.disabled = true; btn.textContent = 'æ¤œç´¢ä¸­...';
  resultsEl.innerHTML = '<div class="loading">ğŸ” æ¤œç´¢ä¸­...</div>';
  clearMarkers();

  try {
    let facilities = [], total = 0, isNearby = false;

    if (userLat && !q) {
      const params = new URLSearchParams({lat: userLat, lng: userLng, radius: 3, limit: 30});
      if (service) params.set('service', service);
      const res = await fetch(`${API}/kaigo/nearby?${params}`);
      facilities = await res.json();
      total = facilities.length;
      isNearby = true;
    } else {
      const params = new URLSearchParams({per_page: 30});
      if (q) params.set('q', q);
      if (service) params.set('service', service);
      const res = await fetch(`${API}/kaigo?${params}`);
      const data = await res.json();
      facilities = data.data;
      total = data.pagination.total;
    }

    renderResults(facilities, total, isNearby, true);
  } catch (e) {
    resultsEl.innerHTML = `<div class="no-results">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
  } finally {
    btn.disabled = false; btn.textContent = 'æ¤œç´¢';
  }
}

function renderResults(facilities, total, isNearby, isKaigo) {
  const resultsEl = document.getElementById('results');
  const statsEl = document.getElementById('statsBar');

  if (!facilities.length) {
    resultsEl.innerHTML = '<div class="no-results">è©²å½“ã™ã‚‹æ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
    statsEl.style.display = 'none';
    return;
  }

  statsEl.textContent = isNearby
    ? `ğŸ“ ç¾åœ¨åœ°å‘¨è¾º ${total}ä»¶ï¼ˆåŠå¾„3kmï¼‰`
    : `${total.toLocaleString()}ä»¶ä¸­ ${facilities.length}ä»¶ã‚’è¡¨ç¤º`;
  statsEl.style.display = 'block';

  resultsEl.innerHTML = '';
  const bounds = [];

  facilities.forEach((fac, i) => {
    const div = document.createElement('div');
    div.className = 'result-item';
    const typeCls = isKaigo ? 'type-kaigo' : 'type-medical';
    const typeLabel = isKaigo ? (fac.service_type || '') : (TYPE_NAMES[fac.facility_type] || '');
    div.innerHTML = `
      <div class="result-name">${fac.name}</div>
      <div class="result-addr">${fac.address||'ä½æ‰€ä¸æ˜'}</div>
      <div class="result-meta">
        <span class="type ${typeCls}">${typeLabel}</span>
        ${fac.distance_km != null ? `<span class="dist">${fac.distance_km}km</span>` : ''}
        ${fac.phone ? `<span>ğŸ“ ${fac.phone}</span>` : ''}
      </div>`;
    div.onclick = () => isKaigo ? showKaigoDetail(fac.id) : showDetail(fac.id);
    resultsEl.appendChild(div);

    if (fac.latitude && fac.longitude) {
      addMarker(fac, i, isKaigo);
      bounds.push([fac.latitude, fac.longitude]);
    }
  });

  if (bounds.length) map.fitBounds(bounds, {padding: [30, 30], maxZoom: 15});
}

async function showDetail(id) {
  const overlay = document.getElementById('detailOverlay');
  const card = document.getElementById('detailCard');
  card.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
  overlay.classList.add('show');

  try {
    const res = await fetch(`${API}/facilities/${id}`);
    const f = await res.json();

    const days = ['mon','tue','wed','thu','fri','sat','sun'];
    const dayNames = {'mon':'æœˆ','tue':'ç«','wed':'æ°´','thu':'æœ¨','fri':'é‡‘','sat':'åœŸ','sun':'æ—¥'};

    let specsHtml = '';
    if (f.specialities && f.specialities.length) {
      const groups = {};
      f.specialities.forEach(s => {
        if (!groups[s.specialty_name]) groups[s.specialty_name] = [];
        groups[s.specialty_name].push(s);
      });
      const merged = [];
      Object.entries(groups).forEach(([name, slots]) => {
        const combined = {};
        let hasAny = false;
        days.forEach(d => {
          const times = [];
          slots.forEach(s => {
            if (s.schedule && s.schedule[d] && s.schedule[d].start) times.push(s.schedule[d]);
          });
          if (times.length) { times.sort((a, b) => a.start.localeCompare(b.start)); combined[d] = times; hasAny = true; }
          else combined[d] = null;
        });
        if (hasAny) merged.push({name, combined});
      });

      const fmtTimes = times => times ? times.map(v => `${v.start.replace(/^0/,'')}-${v.end.replace(/^0/,'')}`).join('<br>') : null;

      specsHtml = '<div class="detail-section"><h3>è¨ºç™‚ç§‘ãƒ»è¨ºç™‚æ™‚é–“</h3><div style="overflow-x:auto;"><table class="schedule-table"><thead><tr><th style="text-align:left;">è¨ºç™‚ç§‘</th>';
      days.forEach(d => { const cls = d==='sat'?' class="day-sat"':d==='sun'?' class="day-sun"':''; specsHtml += `<th${cls}>${dayNames[d]}</th>`; });
      specsHtml += '</tr></thead><tbody>';
      merged.forEach(({name, combined}) => {
        specsHtml += `<tr><td class="spec-name" title="${name}">${name}</td>`;
        days.forEach(d => { const t = fmtTimes(combined[d]); specsHtml += t ? `<td class="on">${t}</td>` : '<td class="off">â€”</td>'; });
        specsHtml += '</tr>';
      });
      specsHtml += '</tbody></table></div></div>';
    }

    let bedsHtml = '';
    if (f.beds) {
      const items = [];
      if (f.beds.general) items.push(`ä¸€èˆ¬ ${f.beds.general}`);
      if (f.beds.recuperation) items.push(`ç™‚é¤Š ${f.beds.recuperation}`);
      if (f.beds.psychiatric) items.push(`ç²¾ç¥ ${f.beds.psychiatric}`);
      if (f.beds.total) items.push(`<strong>åˆè¨ˆ ${f.beds.total}åºŠ</strong>`);
      if (items.length) bedsHtml = `<div class="detail-section"><h3>ğŸ›ï¸ ç—…åºŠæ•°</h3><p style="font-size:0.82rem;">${items.join(' ï½œ ')}</p></div>`;
    }

    card.innerHTML = `
      <button class="close-btn" onclick="closeDetail()">âœ•</button>
      <h2>${f.name}</h2>
      <p style="font-size:0.82rem;color:#666;">${f.name_kana||''}</p>
      <div style="margin-top:0.8rem;display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
        <span class="type type-medical" style="padding:0.2rem 0.6rem;border-radius:4px;font-size:0.8rem;">${f.facility_type_name||TYPE_NAMES[f.facility_type]||''}</span>
        <span style="font-size:0.75rem;color:#999;font-family:monospace;">ID: ${f.id}</span>
        ${f.corporate_number ? `<a href="https://info.gbiz.go.jp/hojin/ichiran?hojinBango=${f.corporate_number}" target="_blank" style="font-size:0.75rem;color:#1a73e8;">æ³•äººç•ªå·: ${f.corporate_number} â†—</a>` : ''}
      </div>
      <p style="font-size:0.85rem;margin-top:0.5rem;">ğŸ“ ${f.address||''}</p>
      ${f.website_url ? `<p style="margin-top:0.3rem;"><a href="${f.website_url}" target="_blank" style="color:#1a73e8;font-size:0.85rem;">ğŸŒ Web</a></p>` : ''}
      ${bedsHtml}
      ${specsHtml}
      ${f.data_date ? `<p style="font-size:0.72rem;color:#bbb;margin-top:1rem;text-align:right;">ãƒ‡ãƒ¼ã‚¿åŸºæº–æ—¥: ${f.data_date}</p>` : ''}
    `;
  } catch(e) {
    card.innerHTML = `<button class="close-btn" onclick="closeDetail()">âœ•</button><p>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>`;
  }
}

async function showKaigoDetail(id) {
  const overlay = document.getElementById('detailOverlay');
  const card = document.getElementById('detailCard');
  card.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
  overlay.classList.add('show');

  try {
    const res = await fetch(`${API}/kaigo/${id}`);
    const services = await res.json();
    if (!services.length) throw new Error('not found');
    const f = services[0];

    const dayNames = {'mon':'æœˆ','tue':'ç«','wed':'æ°´','thu':'æœ¨','fri':'é‡‘','sat':'åœŸ','sun':'æ—¥','holiday':'ç¥'};
    let daysHtml = '';
    if (f.available_days) {
      const open = Object.entries(f.available_days).filter(([,v]) => v).map(([k]) => dayNames[k]||k);
      if (open.length) daysHtml = `<p style="font-size:0.82rem;margin-top:0.5rem;">ğŸ“… åˆ©ç”¨å¯èƒ½: ${open.join('ãƒ»')}</p>`;
    }

    let servicesHtml = '';
    if (services.length > 1) {
      servicesHtml = '<div class="detail-section"><h3>æä¾›ã‚µãƒ¼ãƒ“ã‚¹</h3>';
      services.forEach(s => {
        servicesHtml += `<div style="font-size:0.82rem;padding:0.3rem 0;border-bottom:1px solid #f0f0f0;">
          <span class="type type-kaigo" style="padding:0.1rem 0.5rem;border-radius:4px;">${s.service_type}</span>
          ${s.capacity ? `å®šå“¡: ${s.capacity}å` : ''}
        </div>`;
      });
      servicesHtml += '</div>';
    }

    card.innerHTML = `
      <button class="close-btn" onclick="closeDetail()">âœ•</button>
      <h2>${f.name}</h2>
      <p style="font-size:0.82rem;color:#666;">${f.name_kana||''}</p>
      <div style="margin-top:0.8rem;display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center;">
        <span class="type type-kaigo" style="padding:0.2rem 0.6rem;border-radius:4px;font-size:0.8rem;">${f.service_type}</span>
        <span style="font-size:0.75rem;color:#999;font-family:monospace;">äº‹æ¥­æ‰€ç•ªå·: ${f.id}</span>
        ${f.corporate_number ? `<a href="https://info.gbiz.go.jp/hojin/ichiran?hojinBango=${f.corporate_number}" target="_blank" style="font-size:0.75rem;color:#2e7d32;">æ³•äººç•ªå·: ${f.corporate_number} â†—</a>` : ''}
      </div>
      <p style="font-size:0.85rem;margin-top:0.5rem;">ğŸ“ ${f.address||''} ${f.address_detail||''}</p>
      ${f.phone ? `<p style="font-size:0.85rem;margin-top:0.3rem;">ğŸ“ ${f.phone}</p>` : ''}
      ${f.fax ? `<p style="font-size:0.82rem;color:#666;">ğŸ“  FAX: ${f.fax}</p>` : ''}
      ${f.corporate_name ? `<p style="font-size:0.82rem;margin-top:0.3rem;">ğŸ¢ ${f.corporate_name}</p>` : ''}
      ${f.website_url ? `<p style="margin-top:0.3rem;"><a href="${f.website_url}" target="_blank" style="color:#2e7d32;font-size:0.85rem;">ğŸŒ Web</a></p>` : ''}
      ${daysHtml}
      ${f.capacity ? `<p style="font-size:0.82rem;margin-top:0.3rem;">ğŸ‘¥ å®šå“¡: ${f.capacity}å</p>` : ''}
      ${f.available_days_note ? `<p style="font-size:0.78rem;color:#888;margin-top:0.3rem;">â€» ${f.available_days_note}</p>` : ''}
      ${servicesHtml}
      ${f.note ? `<p style="font-size:0.78rem;color:#888;margin-top:0.5rem;">ğŸ“ ${f.note}</p>` : ''}
    `;
  } catch(e) {
    card.innerHTML = `<button class="close-btn" onclick="closeDetail()">âœ•</button><p>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>`;
  }
}

function closeDetail() {
  document.getElementById('detailOverlay').classList.remove('show');
}

document.querySelectorAll('#q,#specialty').forEach(el => {
  el.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
});
</script>
</body>
</html>
