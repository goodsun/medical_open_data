# Developer Note: 法人番号マッチング — 20万医療施設 × 574万法人の突合

## 背景

医療施設データ（厚労省）には法人番号が含まれていない。
しかし法人番号は日本の法人の一意キーであり、登記・財務・補助金・届出など
あらゆるデータセットとの結合キーになる。データスペース接続の前提条件。

**ゴール: 20万医療施設に、国税庁の574万法人から法人番号を紐づける**

## データソース

| データ | 件数 | 提供元 |
|---|---|---|
| 医療施設 | 200,064件 | 厚生労働省 医療情報ネット |
| 法人番号 | 5,741,920件 | 国税庁 法人番号公表サイト |

国税庁の全件CSV: 1.2GB（Unicode版）、月次更新

## 試行錯誤の経緯

### 第1段階: 法人名抽出 → 完全一致（4.9%）

施設名から法人名を抽出してマッチングする最もシンプルなアプローチ。

```
「医療法人社団慈藻会　平松記念病院」→「医療法人社団慈藻会」を抽出
「渋谷駅前クリニック」→ 抽出不可
```

#### 法人名抽出のパターン

1. **全角スペース区切り**: `医療法人社団〇〇会　△△病院` → 前半を抽出
2. **「会」で切る**: `医療法人社団清和会南札幌病院` → `医療法人社団清和会`
3. **3分割対応**: `医療法人　菊郷会　愛育病院` → `医療法人菊郷会`

#### 結果

```
法人名抽出: 34,055/200,064 (17.0%)
マッチ成功: 9,749/200,064 (4.9%)
```

**問題: 施設の83%は法人名が施設名に含まれていない。**
歯科（16.6%）、薬局（5.4%）、助産所（1.5%）は個人経営が多く、
施設名に法人名が入らない。

### 第2段階: 住所マッチング追加 → だが効かない（4.9%のまま）

住所ベースで突合を試みた。

**最初の失敗: 国税庁CSVの住所カラムが違った。**

```
# 想定: row[12] が完全な住所
corp_addr = row[12]  # → 空文字列！
```

国税庁CSVのフォーマット:
```
row[9]  = 都道府県（例: 東京都）
row[10] = 市区町村（例: 渋谷区）
row[11] = 番地（例: 桜丘町１６番１５号カーサ渋谷２Ｆ）
row[12] = 空（！）
```

住所は3カラムに分割されていた。`row[12]` は完全に別の意味のカラム。

### 第3段階: 住所結合 + 住所キーマッチ（72.4%）

住所を正しく結合し、住所の先頭部分をキーとしてハッシュマップ突合。

```python
corp_addr = row[9] + row[10] + row[11]
# → 「東京都渋谷区桜丘町１６番１５号カーサ渋谷２Ｆ」
```

#### マッチングアルゴリズム

```
Phase 1: 法人名の完全一致マッチ（正規化後）
  施設「医療法人社団慈藻会」 == 国税庁「医療法人社団慈藻会」→ マッチ

Phase 2: 住所キーマッチ（法人名なしの施設にも適用）
  施設住所の先頭30文字 → ハッシュキー
  国税庁住所の先頭30文字 → ハッシュキー
  キーが一致 + 法人種別が施設種別と整合 → マッチ
```

#### 住所キーの設計

```python
def addr_key(addr, level=3):
    norm = normalize_address(addr)  # NFKC正規化 + スペース除去
    return norm[:30]  # 先頭30文字
```

30文字にした理由:
- 短すぎる（10文字）→ 同じ町内の別法人が大量にヒットして誤マッチ
- 長すぎる（全文）→ ビル名や階数の表記揺れでマッチしない
- 30文字 → 「東京都渋谷区桜丘町16番15号」レベルで、ビル名の手前まで含む

#### 法人種別フィルタ

住所だけでマッチすると誤マッチが増える。法人種別で制約をかけた。

```python
# 病院・診療所・歯科 → 医療法人系のみ
# 薬局 → 株式会社・有限会社・医療法人
# 助産所 → 医療法人・一般社団法人
```

これにより「同じビルに入ってる関係ない株式会社」が病院にマッチするのを防止。

### 最終結果

| 種別 | マッチ | 率 | v1比 |
|---|---|---|---|
| 病院 | 5,488/7,640 | **71.8%** | 12.9%→71.8% |
| 診療所 | 56,893/76,988 | **73.9%** | 8.2%→73.9% |
| 歯科 | 35,174/52,985 | **66.4%** | 4.2%→66.4% |
| 助産所 | 838/2,097 | **40.0%** | 0.2%→40.0% |
| 薬局 | 46,526/60,354 | **77.1%** | 0.3%→77.1% |
| **合計** | **144,919/200,064** | **72.4%** | 4.9%→72.4% |

## メモリ最適化

### 失敗: 全件メモリロード（OOM）

最初のアプローチは574万法人を全てメモリに辞書化しようとした。

```
1.2GB CSV → Python dict → 940MB RSS → EC2 (3.8GB RAM) で事実上OOM
```

### 解決: ストリーム読み + 施設側をメモリに載せる

**発想の転換: 小さい方をメモリに載せて、大きい方をストリーム読みする。**

```
施設20万件（住所キー: 283,068エントリ）→ メモリに載せる（~190MB）
法人574万件（1.2GB CSV）→ 1行ずつストリーム読み
```

結果: **メモリ使用量 191MB**（940MB → 191MB、80%削減）

## 技術的な教訓

### 1. 政府オープンデータのCSVフォーマットは信用するな

同じ「住所」でも:
- 厚労省: 1カラムに完全な住所
- 国税庁: 都道府県・市区町村・番地の3カラムに分割

**必ず実データを目視確認してからコードを書く。**

### 2. 住所の正規化は深追いしすぎない

「丁目」vs「-」、全角数字vs半角数字、ビル名の有無...
完璧な正規化は不可能。**先頭N文字のプレフィックスマッチ**が実用的。

### 3. 小さい方をメモリに、大きい方をストリーム

574万 × 20万 のクロスマッチは全探索だと不可能。
ハッシュマップにすれば O(N+M)。
メモリに載せるのは小さい方（20万件）。

### 4. 法人種別フィルタで精度を担保

住所マッチだけだと同一ビルの無関係法人がヒットする。
「病院の住所に株式会社がマッチ」を防ぐために、
施設種別と法人種別の整合性チェックを入れた。

## 残課題と改善案

### マッチできない27.6%の内訳

- **個人事業の医療施設**: 法人化していないので法人番号が存在しない
- **住所表記の大きなズレ**: 登記住所と実際の診療所住所が異なるケース
- **法人名変更**: 合併・名称変更で現在の名前と不一致

### 改善案

1. **国税庁API（アプリID申請中）**: 名称のファジー検索が可能
2. **住所正規化の高度化**: 漢数字↔算用数字、「丁目」↔「-」の相互変換
3. **フリガナマッチ**: 施設のフリガナと法人のフリガナで突合（漢字の揺れを回避）
4. **GビズINFO連携**: 法人の事業所情報（本店以外の住所）でマッチング

---

*2026-02-13 — Phase 1 PoC、法人番号マッチング機能追加時に記録*
*574万法人CSVを191MBのメモリで処理、72.4%のマッチ率を達成*
